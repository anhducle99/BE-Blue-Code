generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  Int                 @id @default(autoincrement())
  name                String
  email               String              @unique
  password            String?
  phone               String?
  role                String              @default("User")
  departmentId        Int?                @map("department_id")
  organizationId      Int?                @map("organization_id")
  isDepartmentAccount Boolean             @default(false) @map("is_department_account")
  isAdminView         Boolean             @default(false) @map("is_admin_view")
  isFloorAccount      Boolean             @default(false) @map("is_floor_account")
  
  zaloUserId          String?             @unique @map("zalo_user_id")
  zaloVerified        Boolean             @default(false) @map("zalo_verified")
  zaloLinkedAt        DateTime?           @map("zalo_linked_at")
  
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")
  department          Department?         @relation(fields: [departmentId], references: [id])
  organization        Organization?       @relation(fields: [organizationId], references: [id])
  zaloLinkCodes       ZaloLinkCode[]

  @@map("users")
}

model Department {
  id             Int            @id @default(autoincrement())
  name           String
  phone          String?
  alertGroup     String?        @map("alert_group")
  organizationId Int?           @map("organization_id")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  historyFrom    History[]      @relation("DepartmentFrom")
  historyTo      History[]      @relation("DepartmentTo")
  users          User[]
  organization   Organization?  @relation(fields: [organizationId], references: [id])

  @@map("departments")
}

model Organization {
  id           Int          @id @default(autoincrement())
  name         String
  urlLogo      String?
  
  zaloOaId     String?      @map("zalo_oa_id")
  zaloOaToken  String?      @map("zalo_oa_token")
  
  createdAt    DateTime     @default(now()) @map("created_at")
  users        User[]
  departments  Department[]
  zaloLinkCodes ZaloLinkCode[]

  @@map("organizations")
}

model History {
  id               Int        @id @default(autoincrement())
  departmentFromId Int        @map("department_from_id")
  departmentToId   Int        @map("department_to_id")
  content          String
  image            String?
  receiverName     String?    @map("receiver_name")
  status           String?    @default("ko liên lạc")
  sentAt           DateTime   @default(now()) @map("sent_at")
  confirmedAt      DateTime?  @map("confirmed_at")
  departmentFrom   Department @relation("DepartmentFrom", fields: [departmentFromId], references: [id])
  departmentTo     Department @relation("DepartmentTo", fields: [departmentToId], references: [id])

  @@map("history")
}

model CallLog {
  id         Int       @id @default(autoincrement())
  callId     String    @map("call_id")
  fromUser   String    @map("from_user")
  toUser     String    @map("to_user")
  message    String?
  imageUrl   String?   @map("image_url")
  status     String    @default("pending") // "pending" | "accepted" | "rejected" | "timeout" | "cancelled" | "unreachable"
  createdAt  DateTime  @default(now()) @map("created_at")
  acceptedAt DateTime? @map("accepted_at")
  rejectedAt DateTime? @map("rejected_at")

  incidentCaseCallLogs IncidentCaseCallLog[]

  @@index([callId])
  @@index([fromUser])
  @@index([toUser])
  @@index([createdAt])
  @@map("call_logs")
}

model IncidentCase {
  id             Int       @id @default(autoincrement())
  organizationId Int       @map("organization_id")
  groupingKey    String    @map("grouping_key")  
  reportCount    Int       @default(1)            @map("report_count")
  createdAt      DateTime  @default(now()) @map("created_at")

  callLogs       IncidentCaseCallLog[]

  @@index([organizationId])
  @@index([groupingKey])
  @@index([createdAt])
  @@map("incident_cases")
}

model IncidentCaseCallLog {
  id             Int         @id @default(autoincrement())
  incidentCaseId Int         @map("incident_case_id")
  callLogId      Int         @unique @map("call_log_id")

  incidentCase   IncidentCase @relation(fields: [incidentCaseId], references: [id], onDelete: Cascade)
  callLog        CallLog      @relation(fields: [callLogId], references: [id], onDelete: Cascade)

  @@index([incidentCaseId])
  @@map("incident_case_call_logs")
}

model HandlerState {
  id                   Int       @id @default(autoincrement())
  handlerKey           String    @unique @map("handler_key")   
  currentIncidentCaseId Int?     @map("current_incident_case_id")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  @@map("handler_states")
}

model ZaloLinkCode {
  id              Int           @id @default(autoincrement())
  code            String        @unique
  userId          Int           @map("user_id")
  organizationId  Int?          @map("organization_id")
  expiredAt       DateTime      @map("expired_at")
  usedAt          DateTime?     @map("used_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization    Organization? @relation(fields: [organizationId], references: [id])
  
  @@index([code])
  @@index([userId])
  @@index([expiredAt])
  @@map("zalo_link_codes")
}

model ZaloEventLog {
  id           Int      @id @default(autoincrement())
  eventId      String   @unique @map("event_id")
  eventName    String   @map("event_name")
  zaloUserId   String?  @map("zalo_user_id")
  payload      Json?
  processedAt  DateTime @default(now()) @map("processed_at")
  createdAt    DateTime @default(now()) @map("created_at")
  
  @@index([eventId])
  @@index([zaloUserId])
  @@index([createdAt])
  @@map("zalo_event_logs")
}
